export NEMORUN_HOME=${STORE_HOME}/.nemo_run

export NEMO_SKILLS_DISABLE_UNCOMMITTED_CHANGES_CHECK=1
export NEMO_SKILLS_CONFIG_DIR=${XDG_CONFIG_HOME}/nemo-skills/cluster_configs

export DATA_DESIGNER_HOME=${XDG_CONFIG_HOME}/nemo-data-designer

function nrlogd {
    if [[ -z "${1}" ]]; then
        echo "[ERROR]: Missing <nemo_experiment_id>."
        echo "Usage:"
        echo "  nrlogd <nemo_experiment_id>"
        return 1
    fi
    exp_id=${1}
    shift 1

    while [[ $# -gt 0 ]]; do
        case $1 in
            --cd)
                do_cd="${1}"
                shift 1
            ;;
            *)
                shift 1
            ;;
        esac
    done

    if [[ "${exp_id}" =~ ^(.*)\_([0-9]+)$ ]]; then
        exp_dir="${NEMORUN_HOME}/${BASH_REMATCH[1]}/${exp_id}"
        if [[ -n "${do_cd}" ]]; then
            unset do_cd
            cd ${exp_dir}
        else
            echo ${exp_dir}
        fi
    else
        echo "[ERROR] Unable to construct directory."
        return 1
    fi
}

function nrlog {
    tail_cmd=(tail -n 500)
    less_cmd=(less)
    while [[ $# -gt 0 ]]; do
        case $1 in
            -j|--job)
                slurm_job_id="${2}"
                shift 2
            ;;
            -g|--group)
                group_name="${2}"
                shift 2
            ;;
            -t|--task)
                task_name="${2}"
                shift 2
            ;;
            -l|--less)
                use_less=1
                shift 1
            ;;
            *)
                tail_cmd+=(${1})
                less_cmd+=(${1})
                shift 1
            ;;
        esac
    done

    if [[ -z "${slurm_job_id}" ]]; then
        echo "[ERROR] Missing slurm job id argument -j"
        return 1
    fi

    if [[ -z "${group_name}" ]]; then
        echo "[ERROR] Missing job name argument -n"
        return 1
    fi

    exp_id=$(sjob ${slurm_job_id})
    if [[ $? -ne 0 ]]; then
        echo "[ERROR] Error getting experiment ID."
        return 1
    else
        exp_id=$(echo "${exp_id}" | jq -r '.name')
    fi

    exp_dir=$(nrlogd ${exp_id})
    if [[ $? -ne 0 ]]; then
        echo "[ERROR] Error getting experiment directory."
        return 1
    fi

    tail_cmd+=(-f ${exp_dir}/${group_name}/*${task_name:-"main"}*${slurm_job_id}*.log)
    less_cmd+=(${exp_dir}/${group_name}/*${task_name:-"main"}*${slurm_job_id}*.log)

    unset slurm_job_id group_name task_name exp_id exp_dir

    if [[ $use_less -eq 1 ]]; then
        unset use_less
        "${less_cmd[@]}"
    else
        "${tail_cmd[@]}"
    fi
}
