#!/usr/bin/env bash

function nemo_run_patch {
    if [[ -z "${1}" ]]; then
        return 0  ## Return 0 exit-code to avoid cascading errors.
    fi

    __sbatch_file="${1}"
    __sbatch_job_arg=$(cat "${__sbatch_file}" | grep -m1 "#SBATCH --job-name=")
    if [[ -n "${__sbatch_job_arg}" ]]; then
        __folder_name="$(basename "$(dirname "${__sbatch_file}")")"

        sed -i "s|^${__sbatch_job_arg}\$|#SBATCH --job-name=${__folder_name}|" "${__sbatch_file}"
    fi
}

for arg in "${@}"; do
    if [[ ! "${arg}" == -* ]] && [[ -f "${arg}" ]]; then
        if file -bi "${arg}" | grep -q "text/x-shellscript"; then
            __sbatch_file="${arg}"
            break
        fi
    fi
done

if [[ -n "${__sbatch_file}" ]]; then
    if cat "${__sbatch_file}" | grep -q "Generated by NeMo Run"; then
        nemo_run_patch "${__sbatch_file}"
    fi
fi

{{ sbatch_bin }} "${@}"
