#!/usr/bin/env bash

#SBATCH --account={{ sbatch_account }}
{% if inventory_hostname == "eos" %}
#SBATCH --partition=interactive
{% elif inventory_hostname == "hsg" %}
#SBATCH --partition=cpu
{% else %}
#SBATCH --partition=cpu_interactive
{% endif %}
#SBATCH --job-name={{ sbatch_account }}-enroot.import
#SBATCH --time=02:00:00
#SBATCH --mem=64G
#SBATCH --output=/home/{{ sbatch_user }}/store/.slurm/logs/%j.log
#SBATCH --error=/home/{{ sbatch_user }}/store/.slurm/logs/%j.log

##
# Usage:
#   mkenroot.sh <docker/image:tag> [output.sqsh]
#

if [[ -z "${1}" ]]; then
    echo "Missing Docker image."
    echo "Usage: mkenroot.sh [docker/image:tag]"
    exit 1
fi
image="${1}"

sqsh_name="${2}"
if [[ -z "${sqsh_name}" ]]; then
    echo "[WARNING] Missing squash name. Setting default."

    sqsh_name=$(echo "${image}" | sed -E -e 's|^(gitlab\-master\.nvidia\.com\/\|nvcr\.io\/)([a-zA-Z\-\_\.]+\/)||' -e 's|[\/:]|-|g')
    sqsh_name="${STORE_HOME}/images/${sqsh_name}.sqsh"
fi

echo "[INFO] Creating squash file \"${sqsh_name}\" for image \"${image}\"..."

mkdir -p "$(dirname "${sqsh_name}")"

export SQSH_CACHE_DIR="${XDG_CACHE_HOME}/sqsh"
export ENROOT_CACHE_PATH="${XDG_CACHE_HOME}/enroot/cache"
export ENROOT_DATA_PATH="${XDG_CACHE_HOME}/enroot/data"

enroot remove -f "$(basename "${sqsh_name%.*}")"
rm -f "${sqsh_name}"

if ! enroot import -o "${sqsh_name}" "docker://${image}"; then
    echo "[ERROR] Failed squash file \"${sqsh_name}\" for image \"${image}\"."
    exit 1
fi
